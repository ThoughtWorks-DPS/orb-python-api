# src/commands/test-coverage.yaml

description: |
  Run pytest against parameter target or . by default, optionally report

  - codeclimate requires CC_TEST_REPORTER_ID to be available in the environment

parameters:

  report-coverage:
    description: report test coverage
    type: enum
    enum: ["codeclimate", "none"]
    default: "none"

steps:
  - run:
      name: run test coverage analysis
      command: |
        coverage run -m pytest -vv -l
        coverage xml --omit='test/*'
  - when:
      name: Use standard pipenv virtual env configuration
      condition:
        equal: [ "codeclimate", << parameters.report-coverage >> ]
      steps:
        - run:
            name: Report test coverage to codeclimate
            command: |
              cc-test-reporter format-coverage -t coverage.py
              cc-test-reporter upload-coverage
